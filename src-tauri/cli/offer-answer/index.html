<html>
  <head>
    <title>ice-restart</title>
  </head>

  <body>
    <button onclick="window.doSignaling(true)"> ICE Restart </button><br />


    <h3> ICE Connection States </h3>
    <div id="iceConnectionStates"></div> <br />

    <h3> ICE Selected Pairs </h3>
    <div id="iceSelectedPairs"></div> <br />

    <h3> Inbound DataChannel Messages </h3>
    <div id="inboundDataChannelMessages"></div>
  </body>

  <script>
    let pc = new RTCPeerConnection({
      iceServers: [
        {
          urls: 'stun:stun.l.google.com:19302'
        }
      ]
    })

    let dc = pc.createDataChannel('data')

    dc.onopen = () => console.log('dc has opened')
    dc.onclose = () => console.log('dc has closed')

    dc.onmessage = event => {
      let el = document.createElement('p')
      el.appendChild(document.createTextNode(event.data))
      document.getElementById('inboundDataChannelMessages').appendChild(el);
    }

    pc.oniceconnectionstatechange = () => {
      let el = document.createElement('p')
      el.appendChild(document.createTextNode(pc.iceConnectionState))
      document.getElementById('iceConnectionStates').appendChild(el);
    }

    // TODO is this ok?
    pc.onnegotiationneeded = (ev) => {
      console.log("onnegotiationneeded!")
      pc.createOffer()
        .then(d => pc.setLocalDescription(d))
        .catch((e) => {
          console.log(`onnegotiationneeded error: ${e}`)
        });
    }

    pc.onicecandidate = event => {
      console.log("on ice candidate " + event)

      console.log(JSON.stringify(pc.localDescription))

      fetch(`http://0.0.0.0:60000/candidate`, {
            method: 'post',
            headers: {
              'Accept': 'application/json, text/plain, */*',
              'Access-Control-Allow-Origin': 'http://0.0.0.0:60000',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(pc.localDescription)
          })

      /* if (event.candidate === null) {
        document.getElementById('localSessionDescription').value = btoa(JSON.stringify(pc.localDescription))
      } */
    }
    


    window.doSignaling = iceRestart => {
      console.log("creating offer")
      pc.createOffer({iceRestart})
        .then(offer => {
          pc.setLocalDescription(offer)

          return fetch(`/sdp`, {
            method: 'post',
            headers: {
              'Accept': 'application/json, text/plain, */*',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(offer)
          })
        })
        .then(res => res.json())
        .then(res => pc.setRemoteDescription(res))
        .catch(alert)
    }



    //window.candidate()
    window.doSignaling(false)
  </script>
</html>
